# å‘é‡æ•°æ®åº“å’ŒåµŒå…¥æœåŠ¡å®æ–½æ€»ç»“

## ä»»åŠ¡å®Œæˆæƒ…å†µ

âœ… **ä»»åŠ¡ 6.1: æ„å»ºå‘é‡æ•°æ®åº“å’ŒåµŒå…¥æœåŠ¡** - å·²å®Œæˆ

## å®æ–½å†…å®¹

### 1. æ ¸å¿ƒæœåŠ¡å®ç°

#### ğŸ”§ å‘é‡æ•°æ®åº“æœåŠ¡ (VectorService)
- **æ–‡ä»¶**: `src/services/vector_service.py`
- **åŠŸèƒ½**: åŸºäºQdrantçš„å‘é‡å­˜å‚¨å’Œæ£€ç´¢
- **ç‰¹æ€§**:
  - æ”¯æŒæ–‡æ¡£å‘é‡åŒ–å­˜å‚¨
  - é«˜æ€§èƒ½ç›¸ä¼¼åº¦æœç´¢
  - é›†åˆç®¡ç†å’Œé…ç½®ä¼˜åŒ–
  - æ‰¹é‡æ“ä½œå’Œå¼‚æ­¥å¤„ç†
  - è¿‡æ»¤å’ŒèšåˆæŸ¥è¯¢

#### ğŸ§  åµŒå…¥æœåŠ¡ (EmbeddingService)
- **æ–‡ä»¶**: `src/services/embedding_service.py`
- **åŠŸèƒ½**: åŸºäºBGE-M3çš„å¤šè¯­è¨€æ–‡æœ¬åµŒå…¥
- **ç‰¹æ€§**:
  - BGE-M3å¤šè¯­è¨€åµŒå…¥æ¨¡å‹
  - BGE-reranker-v2-m3é‡æ’åºæ¨¡å‹
  - æ™ºèƒ½ç¼“å­˜æœºåˆ¶
  - æ‰¹é‡å¤„ç†ä¼˜åŒ–
  - ä¸­è‹±æ–‡è¯­ä¹‰ç†è§£

#### ğŸ” ElasticsearchæœåŠ¡ (ElasticsearchService)
- **æ–‡ä»¶**: `src/services/elasticsearch_service.py`
- **åŠŸèƒ½**: BM25æ–‡æœ¬æœç´¢å’Œå…¨æ–‡æ£€ç´¢
- **ç‰¹æ€§**:
  - å…¨æ–‡æœç´¢å’Œå…³é”®è¯åŒ¹é…
  - é«˜äº®æ˜¾ç¤ºå’Œç»“æœæ’åº
  - ä¸­æ–‡åˆ†è¯æ”¯æŒ(IKåˆ†è¯å™¨)
  - ç´¢å¼•ç®¡ç†å’Œä¼˜åŒ–
  - èšåˆæŸ¥è¯¢å’Œç»Ÿè®¡

#### ğŸ”€ æ··åˆæ£€ç´¢æœåŠ¡ (HybridSearchService)
- **æ–‡ä»¶**: `src/services/hybrid_search_service.py`
- **åŠŸèƒ½**: ç»“åˆå‘é‡æœç´¢å’ŒBM25æœç´¢
- **ç‰¹æ€§**:
  - å¤šç§æœç´¢æ¨¡å¼(å‘é‡ã€BM25ã€æ··åˆ)
  - æ™ºèƒ½ç»“æœèåˆå’Œé‡æ’åº
  - è¯­ä¹‰æœç´¢å’Œç›¸ä¼¼åº¦è®¡ç®—
  - å¯é…ç½®æƒé‡å’Œé˜ˆå€¼
  - ç»Ÿä¸€çš„æœç´¢æ¥å£

### 2. é…ç½®å’Œç¯å¢ƒ

#### ğŸ“ ç¯å¢ƒé…ç½®æ›´æ–°
- **æ–‡ä»¶**: `.env.example`
- **æ–°å¢é…ç½®**:
  ```env
  # Qdrantå‘é‡æ•°æ®åº“
  QDRANT_URL=http://localhost:6333
  QDRANT_API_KEY=your-qdrant-api-key
  
  # Elasticsearchæœç´¢å¼•æ“
  ELASTICSEARCH_URL=http://localhost:9200
  ELASTICSEARCH_USERNAME=elastic
  ELASTICSEARCH_PASSWORD=your-elasticsearch-password
  ELASTICSEARCH_INDEX_PREFIX=hicrm
  
  # BGEåµŒå…¥æ¨¡å‹
  BGE_MODEL_NAME=BAAI/bge-m3
  BGE_RERANKER_MODEL=BAAI/bge-reranker-v2-m3
  BGE_DEVICE=cpu
  ```

#### ğŸ³ Dockeréƒ¨ç½²é…ç½®
- **æ–‡ä»¶**: `docker-compose.vector.yml`
- **æœåŠ¡**:
  - Qdrantå‘é‡æ•°æ®åº“ (ç«¯å£6333/6334)
  - Elasticsearchæœç´¢å¼•æ“ (ç«¯å£9200/9300)
  - Kibanaç®¡ç†ç•Œé¢ (ç«¯å£5601)

#### ğŸ“¦ ä¾èµ–ç®¡ç†
- **æ›´æ–°**: `requirements.txt`, `pyproject.toml`
- **æ–°å¢ä¾èµ–**:
  - `qdrant-client>=1.7.0` - Qdrantå®¢æˆ·ç«¯
  - `sentence-transformers>=2.2.2` - BGEæ¨¡å‹æ”¯æŒ
  - `elasticsearch>=8.11.0` - Elasticsearchå®¢æˆ·ç«¯
  - `numpy>=1.24.3` - æ•°å€¼è®¡ç®—
  - `requests>=2.31.0` - HTTPè¯·æ±‚

### 3. æµ‹è¯•è¦†ç›–

#### ğŸ§ª å•å…ƒæµ‹è¯•
- **å‘é‡æœåŠ¡æµ‹è¯•**: `tests/test_services/test_vector_service.py`
  - æœåŠ¡åˆå§‹åŒ–å’Œé…ç½®
  - æ–‡æ¡£æ·»åŠ å’Œæœç´¢
  - é›†åˆç®¡ç†å’Œç»Ÿè®¡
  - é”™è¯¯å¤„ç†å’Œå¼‚å¸¸æƒ…å†µ

- **åµŒå…¥æœåŠ¡æµ‹è¯•**: `tests/test_services/test_embedding_service.py`
  - æ¨¡å‹åŠ è½½å’Œåˆå§‹åŒ–
  - æ–‡æœ¬ç¼–ç å’Œæ‰¹é‡å¤„ç†
  - ç›¸ä¼¼åº¦è®¡ç®—å’Œé‡æ’åº
  - ç¼“å­˜æœºåˆ¶å’Œæ€§èƒ½ä¼˜åŒ–

- **Elasticsearchæµ‹è¯•**: `tests/test_services/test_elasticsearch_service.py`
  - ç´¢å¼•åˆ›å»ºå’Œç®¡ç†
  - æ–‡æ¡£æ·»åŠ å’Œæœç´¢
  - å¤šå­—æ®µåŒ¹é…å’Œè¿‡æ»¤
  - ç»Ÿè®¡ä¿¡æ¯å’Œå¥åº·æ£€æŸ¥

- **æ··åˆæœç´¢æµ‹è¯•**: `tests/test_services/test_hybrid_search_service.py`
  - å¤šæ¨¡å¼æœç´¢æµ‹è¯•
  - ç»“æœèåˆå’Œé‡æ’åº
  - æƒé‡é…ç½®å’Œä¼˜åŒ–
  - è¯­ä¹‰æœç´¢å’Œç›¸ä¼¼åº¦

#### ğŸ”— é›†æˆæµ‹è¯•
- **æ–‡ä»¶**: `test_integration_vector.py`
- **æµ‹è¯•åœºæ™¯**:
  - ç«¯åˆ°ç«¯æœåŠ¡é›†æˆ
  - å®é™…æ•°æ®åº“è¿æ¥
  - å®Œæ•´æœç´¢æµç¨‹
  - æ€§èƒ½å’Œç¨³å®šæ€§

#### âš¡ åŸºç¡€åŠŸèƒ½æµ‹è¯•
- **æ–‡ä»¶**: `test_vector_simple.py`
- **å¿«é€ŸéªŒè¯**:
  - æœåŠ¡å¯¼å…¥å’Œåˆ›å»º
  - åŸºæœ¬åŠŸèƒ½æµ‹è¯•
  - æ¨¡æ‹Ÿç¯å¢ƒæµ‹è¯•

### 4. æ–‡æ¡£å’ŒæŒ‡å—

#### ğŸ“š è®¾ç½®æŒ‡å—
- **æ–‡ä»¶**: `docs/vector_database_setup.md`
- **å†…å®¹**:
  - æ¶æ„ç»„ä»¶ä»‹ç»
  - å¿«é€Ÿå¼€å§‹æŒ‡å—
  - è¯¦ç»†é…ç½®è¯´æ˜
  - ä½¿ç”¨ç¤ºä¾‹å’Œæœ€ä½³å®è·µ
  - æ€§èƒ½ä¼˜åŒ–å»ºè®®
  - æ•…éšœæ’é™¤æŒ‡å—
  - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

## æŠ€æœ¯ç‰¹ç‚¹

### ğŸš€ æ€§èƒ½ä¼˜åŒ–
1. **å¼‚æ­¥å¤„ç†**: æ‰€æœ‰æœåŠ¡éƒ½é‡‡ç”¨å¼‚æ­¥è®¾è®¡
2. **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡æ–‡æ¡£å¤„ç†å’Œæœç´¢
3. **æ™ºèƒ½ç¼“å­˜**: åµŒå…¥ç»“æœç¼“å­˜ï¼Œå‡å°‘é‡å¤è®¡ç®—
4. **è¿æ¥æ± **: æ•°æ®åº“è¿æ¥æ± ç®¡ç†
5. **ç´¢å¼•ä¼˜åŒ–**: Qdrantå’ŒElasticsearchç´¢å¼•ä¼˜åŒ–

### ğŸŒ å¤šè¯­è¨€æ”¯æŒ
1. **BGE-M3æ¨¡å‹**: ä¸“é—¨ä¼˜åŒ–çš„ä¸­è‹±æ–‡åµŒå…¥æ¨¡å‹
2. **ä¸­æ–‡åˆ†è¯**: Elasticsearch IKåˆ†è¯å™¨æ”¯æŒ
3. **è¯­ä¹‰ç†è§£**: æ·±åº¦è¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®—
4. **æ–‡æœ¬é¢„å¤„ç†**: æ™ºèƒ½æ–‡æœ¬æ¸…ç†å’Œæ ‡å‡†åŒ–

### ğŸ”§ å¯æ‰©å±•æ€§
1. **æ¨¡å—åŒ–è®¾è®¡**: å„æœåŠ¡ç‹¬ç«‹ï¼Œæ˜“äºæ‰©å±•
2. **é…ç½®çµæ´»**: ä¸°å¯Œçš„é…ç½®é€‰é¡¹
3. **æ¥å£ç»Ÿä¸€**: æ ‡å‡†åŒ–çš„æœåŠ¡æ¥å£
4. **æ’ä»¶æ¶æ„**: æ”¯æŒè‡ªå®šä¹‰æ‰©å±•

### ğŸ›¡ï¸ å¯é æ€§
1. **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
2. **é™çº§ç­–ç•¥**: æœåŠ¡ä¸å¯ç”¨æ—¶çš„é™çº§æ–¹æ¡ˆ
3. **å¥åº·æ£€æŸ¥**: æœåŠ¡çŠ¶æ€ç›‘æ§
4. **æ•°æ®ä¸€è‡´æ€§**: å¤šæœåŠ¡æ•°æ®åŒæ­¥ä¿è¯

## ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€å‘é‡æœç´¢
```python
from src.services.vector_service import vector_service, VectorDocument

# åˆå§‹åŒ–å¹¶æ·»åŠ æ–‡æ¡£
await vector_service.initialize()
docs = [VectorDocument("1", "äººå·¥æ™ºèƒ½æŠ€æœ¯", {"type": "tech"})]
await vector_service.add_documents(docs)

# æœç´¢ç›¸ä¼¼æ–‡æ¡£
results = await vector_service.search("AIæŠ€æœ¯", limit=5)
```

### æ··åˆæ£€ç´¢
```python
from src.services.hybrid_search_service import hybrid_search_service, SearchMode

# æ··åˆæœç´¢
results = await hybrid_search_service.search(
    "äººå·¥æ™ºèƒ½", 
    mode=SearchMode.HYBRID,
    vector_weight=0.6,
    bm25_weight=0.4
)
```

### è¯­ä¹‰ç›¸ä¼¼åº¦
```python
from src.services.embedding_service import embedding_service

# è®¡ç®—æ–‡æœ¬ç›¸ä¼¼åº¦
similarity = await embedding_service.compute_similarity(
    "äººå·¥æ™ºèƒ½", "æœºå™¨å­¦ä¹ "
)
```

## éƒ¨ç½²å’Œè¿è¡Œ

### å¼€å‘ç¯å¢ƒ
```bash
# å¯åŠ¨å‘é‡æ•°æ®åº“æœåŠ¡
docker-compose -f docker-compose.vector.yml up -d

# å®‰è£…ä¾èµ–
uv add numpy sentence-transformers qdrant-client elasticsearch

# è¿è¡Œæµ‹è¯•
uv run pytest test_vector_simple.py -v
```

### ç”Ÿäº§ç¯å¢ƒ
```bash
# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘.envæ–‡ä»¶è®¾ç½®å®é™…é…ç½®

# å¯åŠ¨æœåŠ¡
docker-compose -f docker-compose.vector.yml up -d

# è¿è¡Œé›†æˆæµ‹è¯•
uv run python test_integration_vector.py
```

## æ€§èƒ½æŒ‡æ ‡

### é¢„æœŸæ€§èƒ½
- **å‘é‡æœç´¢**: < 100ms (1ä¸‡æ–‡æ¡£)
- **æ··åˆæœç´¢**: < 200ms (1ä¸‡æ–‡æ¡£)
- **æ–‡æ¡£æ·»åŠ **: < 50ms/æ–‡æ¡£ (æ‰¹é‡)
- **åµŒå…¥ç”Ÿæˆ**: < 100ms/æ–‡æ¡£ (CPU)

### èµ„æºéœ€æ±‚
- **å†…å­˜**: æœ€å°‘2GB (åŒ…å«æ¨¡å‹)
- **å­˜å‚¨**: æ ¹æ®æ–‡æ¡£æ•°é‡åŠ¨æ€å¢é•¿
- **CPU**: å¤šæ ¸å¿ƒæ¨è (åµŒå…¥è®¡ç®—)
- **GPU**: å¯é€‰ (åŠ é€ŸåµŒå…¥è®¡ç®—)

## åç»­ä¼˜åŒ–

### çŸ­æœŸä¼˜åŒ–
1. **GPUåŠ é€Ÿ**: æ”¯æŒCUDAåŠ é€ŸåµŒå…¥è®¡ç®—
2. **åˆ†å¸ƒå¼éƒ¨ç½²**: å¤šèŠ‚ç‚¹é›†ç¾¤æ”¯æŒ
3. **ç¼“å­˜ä¼˜åŒ–**: Redisåˆ†å¸ƒå¼ç¼“å­˜
4. **ç›‘æ§å‘Šè­¦**: Prometheus + Grafana

### é•¿æœŸè§„åˆ’
1. **æ¨¡å‹å¾®è°ƒ**: é’ˆå¯¹ä¸šåŠ¡åœºæ™¯çš„æ¨¡å‹ä¼˜åŒ–
2. **å¤šæ¨¡æ€æ”¯æŒ**: å›¾åƒã€éŸ³é¢‘ç­‰å¤šæ¨¡æ€æ£€ç´¢
3. **å®æ—¶æ›´æ–°**: å¢é‡ç´¢å¼•å’Œå®æ—¶åŒæ­¥
4. **æ™ºèƒ½æ¨è**: åŸºäºç”¨æˆ·è¡Œä¸ºçš„ä¸ªæ€§åŒ–æ¨è

## æ€»ç»“

æœ¬æ¬¡å®æ–½æˆåŠŸå®Œæˆäº†ä»»åŠ¡6.1çš„æ‰€æœ‰è¦æ±‚ï¼š

âœ… **éƒ¨ç½²Qdrantå‘é‡æ•°æ®åº“** - å®Œæˆï¼Œæ”¯æŒé«˜æ€§èƒ½å‘é‡å­˜å‚¨å’Œæ£€ç´¢
âœ… **é›†æˆBGE-M3å¤šè¯­è¨€åµŒå…¥æ¨¡å‹** - å®Œæˆï¼Œä¼˜ç§€çš„ä¸­è‹±æ–‡è¯­ä¹‰ç†è§£èƒ½åŠ›  
âœ… **å®ç°æ··åˆæ£€ç´¢(å‘é‡+BM25)** - å®Œæˆï¼Œç»“åˆQdrantå’ŒElasticsearch
âœ… **åˆ›å»ºä¸­æ–‡è¯­ä¹‰æœç´¢å’Œç›¸ä¼¼åº¦è®¡ç®—åŠŸèƒ½** - å®Œæˆï¼Œä¸“é—¨ä¼˜åŒ–ä¸­æ–‡åœºæ™¯
âœ… **ç¼–å†™å‘é‡æœåŠ¡çš„pytestå•å…ƒæµ‹è¯•** - å®Œæˆï¼Œå…¨é¢çš„æµ‹è¯•è¦†ç›–

ç³»ç»Ÿç°åœ¨å…·å¤‡äº†å¼ºå¤§çš„è¯­ä¹‰æœç´¢å’ŒçŸ¥è¯†æ£€ç´¢èƒ½åŠ›ï¼Œä¸ºåç»­çš„RAGçŸ¥è¯†å¢å¼ºç³»ç»Ÿå’ŒAgentåä½œå¥ å®šäº†åšå®çš„åŸºç¡€ã€‚æ‰€æœ‰æœåŠ¡éƒ½ç»è¿‡äº†å……åˆ†çš„æµ‹è¯•ï¼Œå…·å¤‡ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²çš„æ¡ä»¶ã€‚